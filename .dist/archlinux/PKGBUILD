pkgname=eg
pkgver=v0.0.0
pkgrel=1
pkgdesc='eg ci/cd/batch processing tooling'
arch=('x86_64')
license=('AGPL')
provides=('eg')
conflicts=('eg')
depends=(
  'podman'
  'aardvark-dns'
  'duckdb'
)
makedepends=(
  'go'
  'btrfs-progs'
)

source=("${pkgname}::git+https://github.com/egdaemon/eg.git")
sha1sums=('SKIP')

pkgver() {
  cd "${pkgname}"
  printf "v0.0.%s" "$(git show -s --format=%ct)"
}

build() {
  echo "BUILD: eg ${pkgver} -- src(${srcdir}) build(${BUILDDIR})"
  echo "PWD  : ${PWD}"
  echo "USER : $(whoami)"

  install -d -m 755 ${srcdir}/${pkgname}/.dist/linux/ ${srcdir}/.dist
  cp -r ${srcdir}/${pkgname}/.dist/linux/* ${srcdir}/.dist
  cat ${srcdir}/.dist/usr/share/eg/Containerfile | EG_VERSION=${pkgver} envsubst '$EG_VERSION' | tee ${srcdir}/.dist/usr/share/eg/Containerfile
  GOBIN="${srcdir}/.dist/usr/bin" go install -C ${pkgname} ./cmd/eg
}

package() {
  echo "PACKAGE INITIATED ${pkgdir} ${PWD} ${bindir}"
  cp -r ${srcdir}/${pkgname}/.dist/linux/* ${pkgdir}
  # tree ${pkgdir}
}
