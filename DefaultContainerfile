FROM ubuntu:oracular

# put apt in non-interactive mode
ENV DEBIAN_FRONTEND=noninteractive

RUN apt update

# general utilities
RUN apt install -o Acquire::ForceIPv4=true -y software-properties-common build-essential ca-certificates curl sudo
RUN add-apt-repository -n ppa:longsleep/golang-backports
RUN add-apt-repository -n ppa:egdaemon/eg
RUN add-apt-repository -n ppa:egdaemon/duckdb
RUN apt update

RUN apt install -o Acquire::ForceIPv4=true -y --no-install-recommends curl gnupg2 lsb-release iproute2 git apt-file pinentry-tty uidmap dbus-user-session
RUN apt install -o Acquire::ForceIPv4=true -y --no-install-recommends ssh podman netavark rsync vim golang-1.23 eg tree fuse-overlayfs
# dependencies for duckdb while bootstrapping
RUN apt install -o Acquire::ForceIPv4=true -y --no-install-recommends cmake ninja-build ccache dput devscripts dh-make dput libssl-dev
RUN apt install -o Acquire::ForceIPv4=true -y --no-install-recommends duckdb

# properly link golang into the path.
RUN ln -s /usr/lib/go-1.23/bin/go /usr/local/bin/go

# preload some well known hosts
RUN ssh-keyscan -H github.com >> /etc/ssh/ssh_known_hosts
RUN ssh-keyscan -H gitlab.com >> /etc/ssh/ssh_known_hosts

RUN systemctl enable ssh

RUN systemd-sysusers
RUN systemd-tmpfiles --create

# ensure the clone directory is marked as safe to deal with permissioning issues.
# until we can identify a way to resolve the problem holistically.
RUN sudo -E -H -u egd git config --global --add safe.directory /opt/eg

RUN printf '%%wheel ALL=(ALL:ALL) NOPASSWD: ALL\n' | tee -a /etc/sudoers.d/egd
