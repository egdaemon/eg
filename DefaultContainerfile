FROM ubuntu:plucky

ARG GOBIN="/usr/bin"
ARG GOMODCACHE="/tmp/gomod"
ARG GOCACHE="/tmp/gocache"

RUN echo "cache buster 059a9a06-1686-4f49-9a7f-a30535886d55"
# put apt in non-interactive mode
ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update

# general utilities
RUN apt-get install -y software-properties-common build-essential ca-certificates curl sudo gnupg2 lsb-release iproute2 git apt-file uidmap dbus-user-session fuse-overlayfs rsync vim genisoimage
RUN add-apt-repository -n ppa:longsleep/golang-backports
RUN add-apt-repository -n ppa:egdaemon/eg
RUN add-apt-repository -n ppa:egdaemon/duckdb

RUN echo "cache buster 059a9a06-1686-4f49-9a7f-a30535886d55"
RUN apt-get update
RUN apt-get install -y --no-install-recommends ssh podman netavark golang-1.25 eg egbootstrap tree nftables iptables acl

RUN sh /usr/share/eg/install/github.sh
RUN apt-get update
RUN apt-get install -y gh

# properly link golang into the path.
RUN ln -s /usr/lib/go-1.25/bin/go /usr/local/bin/go

# preload some well known hosts
RUN ssh-keyscan -H github.com >> /etc/ssh/ssh_known_hosts
RUN ssh-keyscan -H gitlab.com >> /etc/ssh/ssh_known_hosts

# # temporary while we deal with launchpad slowness...
# RUN apt-get install -y --no-install-recommends libbtrfs-dev libassuan-dev libc6-dev libdevmapper-dev libglib2.0-dev libgpgme-dev libgpg-error-dev libprotobuf-dev libprotobuf-c-dev libseccomp-dev libselinux1-dev libsystemd-dev
# RUN GOPROXY=direct go install github.com/egdaemon/eg/...@latest

RUN systemd-sysusers
RUN systemd-tmpfiles --create
RUN systemd-tmpfiles --clean

RUN rm -rf /tmp/gomod /tmp/gocache

RUN usermod --add-subuids 100000-165535 --add-subgids 100000-165535 egd
RUN echo "cache buster 3a7ae214-713c-47e0-843d-33590579c251"

# Socket activation fails in nested containers; enable service directly.
RUN systemctl enable podman.socket
RUN systemctl enable podman.service
RUN systemctl disable systemd-resolved.service

# Configure podman socket to be accessible by egd user via the 'eg' group
RUN mkdir -p /etc/systemd/system/podman.socket.d
RUN printf '[Socket]\nSocketGroup=eg\nSocketMode=0660\n' > /etc/systemd/system/podman.socket.d/override.conf
RUN usermod -aG eg egd

# Symlink created at boot via tmpfiles.d (/run is tmpfs).
# Outer container: resolves to local socket. Nested: parent's bind mount overwrites path.
RUN printf 'L /run/eg-parent-podman.sock - - - - /run/podman/podman.sock\n' > /etc/tmpfiles.d/eg-podman-socket.conf
ENV EG_PODMAN_SOCKET=/run/eg-parent-podman.sock

RUN podman version

# BEGIN HACKS
# binfmt_misc automount requires kernel access unavailable in containers - mask it to prevent systemd degraded state
RUN systemctl mask proc-sys-fs-binfmt_misc.automount
# systemd-resolved.service causes the container to delay its startup significantly causing issues.
RUN systemctl disable systemd-resolved.service
# the standard dbus service doesn't work with plucky.
RUN apt-get install -y --no-install-recommends dbus-broker
RUN systemctl disable dbus.service
RUN echo "cache buster 686ca506-2797-505a-ae80-b41535886d79"
RUN systemctl enable dbus-broker.service
RUN rm -rf /run/containers/storage /run/libpod
# END HACKS